<style>

    table .baseto10 { border-collapse: collapse; width: 100%; margin: 1rem 0; }
    th, td { border: 1px solid #ddd; padding: 8px 10px; text-align: center; }
    th { background: #f5f5f5; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

</style>
{% import "base/binmacros.html" as binmacro %}
{# Macro: one manual vertical division step #}
{% macro division_step(dividend, divisor, quotient, remainder, x=0, y=0, cell_w=30, cell_h=30, font_size=16) %}
  {% set char_size = 12 %}
<g transform="translate({{x}},{{y}})" font-family="monospace" font-size="{{font_size}}">
  {% set cell_w1= cell_w %}
  {% set cell_w2= cell_w %}
  <!-- Draw vertical bar -->
  <line x1="{{ cell_w1 }}" y1="0" x2="{{ cell_w1 }}" y2="{{ cell_h*2 }}" stroke="black"/>
  <!-- Draw Horizental  bar -->
  <line x1="{{ cell_w1 }}" y1="{{ cell_h }}" x2="{{ cell_w1+cell_w2 }}" y2="{{ cell_h }}" stroke="black"/>
  <!-- Dividend -->
  <text x="{{ cell_w1-4 }}" y="{{ cell_h*0.75 }}" text-anchor="end">{{ dividend }}</text>
  <!-- Divisor -->
  <text x="{{ cell_w1+4 }}" y="{{ cell_h*0.75 }}" text-anchor="start">{{ divisor }}</text>
  <!-- Quotient -->
  <text x="{{ cell_w1+cell_w2+4 }}" y="{{ cell_h*1.75 }}" text-anchor="end">{{ quotient }}</text>
  <!-- Remainder -->
  <text x="{{ cell_w1/2 }}" y="{{ cell_h*1.75 }}" text-anchor="middle">{{ remainder }}</text>
<!--  <text x="{{ cell_w1 }}" y="{{ cell_h*2.75 }}">num_width={{ div_width }},cell_w1={{cell_w1}}, cell_w2={{cell_w2}}</text>-->
</g>
{% endmacro %}


{# Macro: whole division with successive steps #}
{% macro division_process(dividend, divisor, steps, cell_h=30) %}
{% set char_size = 12 %}
<svg xmlns="http://www.w3.org/2000/svg"
     width="{{ (steps|length+1) * char_size*((dividend|string)|length)*1.2 + 20 }}" height="{{ (steps|length+1) * cell_h*1.2 + 50 }}">
  <!-- First header -->
  <g transform="translate(20,20)">
    <text x="0" y="{{cell_h*0.75}}">Dividend: {{ dividend }}</text>
    <text x="200" y="{{cell_h*0.75}}">Divisor: {{ divisor }}</text>
  </g>

  {% set div_width = char_size*((dividend|string)|length) %}
  {% set cell_w = div_width %}
  <!-- Steps -->
  {% set ns= namespace(y_offset = 80, x_offset=20) %}
  {% set x_offset = 20 %}
  {% for s in steps %}
  <!-- In case of first step, display dividend, else not, it's the previous quotient -->
    {%set dividend_str = s.dividend if loop.first else "" %}
    {{ division_step(dividend_str, divisor, s.quotient, s.remainder, ns.x_offset, ns.y_offset, cell_w, cell_h) }}
    {% set ns.y_offset = ns.y_offset + cell_h %}
    {% set ns.x_offset = ns.x_offset + cell_w*1.1 %}
  {% endfor %}
</svg>
{% endmacro %}

{% macro base_conversion_table(digits, base, number_label="") %}
  <h4>{{tr("Table: base {base} representation", base=base)}}</h4>
  {% if number_label %}
    <div class="small">{{ tr("Number in base {base}", base=base)}}: <span class="mono">{{ number_label }}</span></div>
  {% endif %}
  <table class="baseto10">
    <tr>
      {# First row: powers of base #}
      {% for d in digits %}
        <th class="mono">{{ base }}<sup>{{ loop.revindex0 }}</sup></th>
      {% endfor %}
    </tr>
    <tr>
      {# Second row: the digits themselves #}
      {% for d in digits %}
        <td class="mono">{{ d.symbol }}</td>
      {% endfor %}
    </tr>
  </table>
{% endmacro %}


 {% macro base_sum_expression(digits, base) %}
  <h4>{{tr("Base {base} → 10 Expansion", base=base)}}</h4>
  <ul>
    {# 1) symbolic line with digit symbols #}
    <li>
      <span class="mono">
        N =
        {% for d in digits %}
          {% set i = loop.revindex0 %}
          {{ d.symbol }}·{{ base }}<sup>{{ i }}</sup>
          {% if not loop.last %}+{% endif %}
        {% endfor %}
      </span>
    </li>

    {# 2) replace symbols with values #}
    <li>
      <span class="mono">
        N =
        {% for d in digits %}
          {% set i = loop.revindex0 %}
          {{ d.value }}·{{ base }}<sup>{{ i }}</sup>
          {% if not loop.last %}+{% endif %}
        {% endfor %}
      </span>
    </li>

    {# 3) just numeric products #}
    <li>
      <span class="mono">
        N =
        {% set ns = namespace(total = 0) %}
        {% for d in digits %}
          {% set i = loop.revindex0 %}
          {% set product = d.value * (base ** i) %}
          {% set ns.total = ns.total + product %}
          {{ product }}
          {% if not loop.last %}+{% endif %}
        {% endfor %}
      </span>
    </li>

    {# 4) final total #}
    <li>
      <span class="mono">N = {{ ns.total }}</span>
    </li>
  </ul>
{% endmacro %}


<p>
{{tr("Convert the following numbers")}}
<!--<span dir="rtl">أنجز التحويلات الآتية</span><br/>-->
</p>
{% if RENDER_MODE == "question" %}
({{ number|group4 }})<sub>{{ in_base }} </sub> = (........)<sub>{{ out_base }} </sub> <br/>
{% elif RENDER_MODE == "answer" %}
({{ number|group4 }})<sub>{{ in_base }} </sub>  = (  {{ output|group4 }})<sub>{{ out_base }} </sub><br/>



<style>
  .vr { border-left: 1px solid black; padding-left: 4px; }
  .hr { border-top: 1px solid black; margin-top: -1px; }
</style>
{% if binary_mode %}
  {{ binmacro.base_convert_table(number, in_base, out_base) }}
{% endif %}
{% if steps_to10 and steps_from10 %}
  <h3>{{tr("Convert from base {in_base} to base {out_base}", in_base=in_base, out_base=out_base)}}</h3>
<ol>
  <li>{{tr("Convert from base {in_base} to base 10", in_base=in_base)}}</li>
  <li>{{tr("Convert from base 10 to base {out_base}", out_base=out_base)}}</li>
  </ol>
{% endif %}

<!-- Explanation of Base X to 10 -->
{% if steps_to10 %}
{% set digits = steps_to10 %}
  <h3>{{tr("Convert from base {in_base} to base 10", in_base=in_base)}}</h3>

  {{ base_conversion_table(digits, in_base, number_label) }}
  {{ base_sum_expression(digits, in_base) }}

{{tr("Result")}} : {{ output }}

{% endif %}

<!-- Explanation of Base 10 to X -->

{% if steps_from10 %}
  <h3>{{tr("Convert from base 10 to base {out_base}", out_base=out_base)}}</h3>
 {% set number_b10 = number_tmp if number_tmp else number %}
{{ division_process( number_b10, out_base, steps_from10, cell_h=30)}}


{{tr("Result")}} (bottom→top remainders): ({{ output }})<sub>{{out_base}}</sub>

{% endif %}

{% endif %}

