{% set debug = False %}
{% import "sequential/macros/flipmacros.tex" as flpmacro%}
{% import "sequential/macros/timingmacros.tex" as tmmacro%}
{# -----------------------
 draw a resiter generic
-------------------#}
{%macro _draw_register_generic(flips_list= ["D","JK","RS"], outputs=["Q0","Q1", "Q2"],size=3, shift="right")%}

{% if size != flips_list|length or size != outputs|length %}
 Warning: check parameters, The size '{{size}}' is different from flips list length '{{flips_list|length}}' or
 '{{outputs|length}}'
{%else%}
    {# draw a clock #}
    {{ flpmacro.draw_clock(name="Ck", label="Ck", xpos=0, ypos=0)}}
    {# draw a modules #}
    {% set ns = namespace(name="", id="", xpos=0, prev_name="", prev_type="", type="") %}
    {% set ypos = 2 %}
    {% for i in range(size) %}
        {% set ns.xpos = 2+3*i %}
        {% set ns.name = "flip"+(i|string) %}
        {% set ns.type = flips_list[i].upper() %}
        {% set ns.id = flips_list[i].upper() %}
        {{ flpmacro.place_flip(id=ns.id, name=ns.name, xpos=ns.xpos, ypos=ypos)}}

        {# link current with clock #}
        {{ flpmacro.link_clock (name_clock="Ck", name_target=ns.name, type_target=ns.type)}}

        {# draw a intput vars lines #}
        {% if shift =="right" and loop.first or shift=="left" and loop.last %}
        {{ flpmacro.draw_input_var(name="E", label="E", xpos=ns.xpos-1.3, ypos=ypos+2)}}
        {{ flpmacro.link_var(name_var="E", name_target=ns.name, type_target=ns.type, target_pins=["pin 1"])}}
        {%endif%}

        {# link previous with current #}
        {% if ns.prev_name and shift not in ("left",) %}
            {{ flpmacro.link(name_source=ns.prev_name, name_target=ns.name, type_target=ns.type, method="direct")}}
        {% endif %}

       {# draw a output vars lines #}
        {{ flpmacro.draw_input_var(name=outputs[i], label=outputs[i], xpos=ns.xpos+1, ypos=ypos+2)}}
        {{ flpmacro.link_var(name_var=outputs[i], name_target=ns.name, type_target=ns.type, target_pins=["pin 6"])}}


        {# if register is left shift, draw links from Qi to input of flip i-1 #}
       {% if shift in ("left",)%}
            {% if not loop.first %}
            {{ flpmacro.link_var(name_var=outputs[i], name_target=ns.prev_name, type_target=ns.prev_type, target_pins=["pin 1"],
                reverse=True,
                xshift=0,
                yshift=-0.3-0.1*i,
            )}}
        {% endif %} {# if shift #}
        {% endif %}



        {% set ns.prev_name = ns.name %}
        {% set ns.prev_type = ns.type %}
    {%endfor%}

{%endif%}
{%endmacro%}


{# -----------------------
 draw a resiter one type flip
-------------------#}
{%macro draw_register(flip="D", register_type="",size=3)%}
{% set flips_list = [flip]*size %}
{% set ns = namespace(outputs = []) %}
{% for i in range(size) %}
    {% set _ = ns.outputs.append("Q" ~ i|string) %}
{% endfor %}
{{ _draw_register_generic(flips_list= flips_list, outputs=ns.outputs,size=size)}}

{%endmacro%}

{#----------------------------------------------------------
 Main_call
----------------------------------------------------------#}
\section{Register}

{#  --------------- Define basic flips -------#}
{{flpmacro.define_standard_flips()}}

{% if RENDER_MODE == "question" %}

    Let have the following setup
    \begin{arab}[utf]
إليك هذا التركيب
    \end{arab}

    %\begin{circuitikz}
    {#{draw_register(flip= register_data.flip_type_list[0], register_type=register_data.type,size=register_data.nbits)}#}
    %\end{circuitikz}

    \begin{circuitikz}
    {{_draw_register_generic(flips_list= register_data.flip_type_list, outputs=register_data.outputs,
                            size=register_data.nbits,
                            shift=register_data.shift)}}
    \end{circuitikz}

    Cite the truth table of flipflop {{register_data.flip_type_list[0]}}.

    \begin{arab}[utf]
    اذكر جدول الحقيقة للقلاب \LR{ {{register_data.flip_type_list[0]}}}.
    \end{arab}

   Complete the following timing diaragm, according to given flipflop.

       \begin{arab}[utf]
أكمل المخطط المنطقي الآتي، حسب القلاب المعطى.
    \end{arab}

  {{tmmacro.draw_timing_diagram(data, mode="question")}}

{%endif%} % end quesion
{#----------------------------------------------------------
  Answer
----------------------------------------------------------#}
{% if RENDER_MODE == "answer" %}

        Cite the truth table of flipflop {{register_data.flip_type_list[0]}}.

        \begin{arab}[utf]
        اذكر جدول الحقيقة للقلاب \LR{ {{register_data.flip_type_list[0]}}}.
        \end{arab}

        {{flpmacro.truth_table(type=register_data.flip_type_list[0],
                    edge="rising")}}

   {{tmmacro.draw_timing_diagram(data, mode="answer")}}

{%endif%}




{%if debug and RENDER_MODE == "answer" %}
\newpage
 \textbf{Register}

\begin{circuitikz}
{{_draw_register_generic(flips_list= ["D","JK","RS"], outputs=["Q0","Q1", "Q2"],size=3)}}

\end{circuitikz}

 \textbf{Register  n bits}

\begin{circuitikz}
{{draw_register(flip="D", register_type="",size=6)}}

\end{circuitikz}

 \textbf{Register  n bits Jk}

\begin{circuitikz}
{{draw_register(flip="JK", register_type="",size=6)}}

\end{circuitikz}
{%endif%} % end of if