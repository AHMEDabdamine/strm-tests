{% set debug = True %}
{% import "sequential/macros/flipmacros.html" as flpmacro%}
{% import "sequential/macros/timingmacros.html" as tmmacro%}

{# -----------------------
 draw a resiter generic
-------------------#}
{%macro _draw_register_generic(flips_list= ["D","JK","RS"], outputs=["Q0","Q1", "Q2"],size=3, shift="right", link="direct")%}

{% if size != flips_list|length or size != outputs|length %}
 Warning: check parameters, The size '{{size}}' is different from flips list length '{{flips_list|length}}' or
 '{{outputs|length}}'
{%else%}
<g transform="translate(25,20)">

    {# draw a modules #}
    {% set ns = namespace(name="", id="", xpos=0, prev_name="", prev_type="", type="", output_var_xshift=0) %}
    {% set ypos = 20 %}
    {% set flip_shift = 100 %}
    {% set input_var_xshift = -5 %}
    {% set input_var_yshift = 0 %}
    {% set ns.output_var_xshift = 80  %}
    {% set output_var_yshift = 0 %}

    {% set clk_xpos = -20 %}
    {% set clk_ypos = 140 %}
    {# draw a clock #}
    {{ flpmacro.draw_clock(name="Ck", label="Ck", xpos=clk_xpos, ypos=clk_ypos, length=flip_shift*(size-1))}}

    {% for i in range(size) %}

        {% set ns.xpos = flip_shift*i %}

        {% set ns.name = "flip"+(i|string) %}
        {% set ns.type = flips_list[i].upper() %}
        {% set ns.id = flips_list[i].upper() %}
        <g id="regmodule{{i}}" transform="translate({{ns.xpos}},{{ypos}})">
        {{ flpmacro.place_flip(id=ns.id, name=ns.name, xpos=0, ypos=ypos)}}

        {# link current with clock #}
        {{ flpmacro.link_clock (name_clock="Ck", name_target=ns.name, type_target=ns.type)}}

        {# draw a intput vars lines #}
        {% if shift =="right" and loop.first or shift=="left" and loop.last %}
        {{ flpmacro.draw_input_var(name="E", label="E", xpos=input_var_xshift, ypos=input_var_yshift)}}
        {{ flpmacro.link_var(name_var="E", name_target=ns.name, type_target=ns.type, target_pins=["pin 1"],
            xshift=input_var_xshift, yshift=input_var_yshift)}}
        {%endif%}

        {# link previous with current #}
        {% if ns.prev_name and shift not in ("left",) %}
            {{ flpmacro.link(name_source=ns.prev_name, name_target=ns.name, type_target=ns.type, method=link)}}
        {% endif %}

       {# draw a output vars lines #}
        {{ flpmacro.draw_input_var(name=outputs[i], label=outputs[i], xpos=ns.output_var_xshift, ypos=output_var_yshift)}}
        {{ flpmacro.link_var(name_var=outputs[i], name_target=ns.name, type_target=ns.type, target_pins=["pin 6"],
            xshift=ns.output_var_xshift, yshift=output_var_yshift)}}


        {# if register is left shift, draw links from Qi to input of flip i-1 #}
       {% if shift in ("left",)%}
            {% if not loop.first %}
            {{ flpmacro.link_var(name_var=outputs[i], name_target=ns.prev_name, type_target=ns.prev_type, target_pins=["pin 1"],
                reverse=True,
                xshift=0,
                yshift=5+2.5*i,
            )}}
        {% endif %} {# if shift #}
        {% endif %}



        {% set ns.prev_name = ns.name %}
        {% set ns.prev_type = ns.type %}
         </g> <!-- end register module-->
    {%endfor%}
 </g> <!-- end register group-->
{%endif%}
{%endmacro%}

{# -----------------------
 draw a resiter one type flip
-------------------#}
{%macro draw_register(flip="D", register_type="",size=3)%}
{% set flips_list = [flip]*size %}
{% set ns = namespace(outputs = []) %}
{% for i in range(size) %}
    {% set _ = ns.outputs.append("Q" ~ i|string) %}
{% endfor %}
{{ _draw_register_generic(flips_list= flips_list, outputs=ns.outputs,size=size)}}

{%endmacro%}
<!-- ----------------------------------------------------------
 Main_call
----------------------------------------------------------- -->
<h2>Register</h2>

<!-- --------------- Define basic flips ------- -->
<svg width="0" height="0" xmlns="http://www.w3.org/2000/svg">
{{flpmacro.define_standard_flips()}}
</svg>
{% if RENDER_MODE == "question" %}

    <p>
        Let have the following setup
    </p>
    <div class="arabic">
        إليك هذا التركيب
    </div>

    <!-- Original LaTeX circuitikz replaced by container -->
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">

        {{_draw_register_generic(
            flips_list=register_data.flip_type_list,
            outputs=register_data.outputs,
            size=register_data.nbits,
            shift=register_data.shift
        )}}
    </svg>



    <p>
        Cite the truth table of flipflop {{register_data.flip_type_list[0]}}.
    </p>
    <div class="arabic">
        اذكر جدول الحقيقة للقلاب <span class="lr">{{register_data.flip_type_list[0]}}</span>.
    </div>

    <p>
        Complete the following timing diagram, according to given flipflop.
    </p>
    <div class="arabic">
        أكمل المخطط المنطقي الآتي، حسب القلاب المعطى.
    </div>

    {{tmmacro.draw_timing_diagram(data, mode="question")}}

{% endif %} <!-- end question -->


<!-- ----------------------------------------------------------
  Answer
----------------------------------------------------------- -->
{% if RENDER_MODE == "answer" %}

    <p>
        Cite the truth table of flipflop {{register_data.flip_type_list[0]}}.
    </p>
    <div class="arabic">
        اذكر جدول الحقيقة للقلاب <span class="lr">{{register_data.flip_type_list[0]}}</span>.
    </div>

    {{flpmacro.truth_table(
        type=register_data.flip_type_list[0],
        edge="rising"
    )}}

    {{tmmacro.draw_timing_diagram(data, mode="answer")}}

{% endif %}


<!-- Debug Section -->
{% if debug and RENDER_MODE == "answer" %}
    <hr>
    <b>Register</b>
    <svg width="600" height="300" xmlns="http://www.w3.org/2000/svg">

        {{_draw_register_generic(flips_list=["D","JK","RST"], outputs=["Q0","Q1","Q2"], size=3)}}
    </svg>

    <b>Register n bits</b>
    <svg width="600" height="300" xmlns="http://www.w3.org/2000/svg">

        {{draw_register(flip="D", register_type="", size=6)}}
    </svg>

    <b>Register n bits JK</b>
    <svg width="600" height="300" xmlns="http://www.w3.org/2000/svg">
        {{draw_register(flip="JK", register_type="", size=6)}}
    </svg>


Test inverse connection
    <!-- Original LaTeX circuitikz replaced by container -->
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">

        {{_draw_register_generic(
            flips_list=register_data.flip_type_list,
            outputs=register_data.outputs,
            size=register_data.nbits,
            shift=register_data.shift,
    link="inverse",
        )}}
    </svg>

Test clock connection
    <!-- Original LaTeX circuitikz replaced by container -->
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">

        {{_draw_register_generic(
            flips_list=register_data.flip_type_list,
            outputs=register_data.outputs,
            size=register_data.nbits,
            shift=register_data.shift,
    link="clock",
        )}}
    </svg>

Test inverse clock connection
    <!-- Original LaTeX circuitikz replaced by container -->
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">

        {{_draw_register_generic(
            flips_list=register_data.flip_type_list,
            outputs=register_data.outputs,
            size=register_data.nbits,
            shift=register_data.shift,
    link="inverse_clock",
        )}}
    </svg>
{% endif %}
