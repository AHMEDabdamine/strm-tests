<!--quiz.html-->
<!DOCTYPE html>
{% set debug= True %}
<html>
<head>
    <style>
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-right: 8px;
  vertical-align: middle;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.hint {
  font-size: 0.85em;
  color: #666;
  margin-top: 2px;
  margin-bottom: 8px;
}
</style>
<link rel="icon" href="{{ url_for('static', path='favicon.ico') }}">
    <title>Quiz</title>
    <script>
        // This will be filled by Jinja as JSON
        const commandsInfo = {{ commands_dict_json | safe }};
        const categoryCommands = {{ category_commands_json | safe }};


function updateArgsForm() {
            const command = document.getElementById("selectcommand").value;
            const argsDiv = document.getElementById("argsForm");
            const exampleDiv = document.getElementById("exampleDiv");
            argsDiv.innerHTML = ""; // clear old fields

            if (command === "random") return;

            const cmdInfo = commandsInfo[command];
            if (!cmdInfo || !cmdInfo.args) return;

            for (const [argName, argMeta] of Object.entries(cmdInfo.args)) {
                const label = document.createElement("label");
//                label.textContent = argName + ": ";
                label.textContent = argMeta.label + ": ";
                label.setAttribute("for", argName);

                let input;
                switch (argMeta.type) {
                    case "string":
                        input = document.createElement("input");
                        input.type = "text";
                        input.value = argMeta.default || "";
                        break;
                    case "integer":
                        input = document.createElement("input");
                        input.type = "number";
                        input.value = argMeta.default || 0;
                        if (argMeta.range) {
                            input.min = argMeta.range[0];
                            input.max = argMeta.range[1];
                        }
                        break;
                    case "boolean":
                        input = document.createElement("input");
                        input.type = "checkbox";
                        input.checked = argMeta.default || false;
                        break;
                    case "list":
                        input = document.createElement("textarea");
                        input.rows = 2;
                        input.placeholder = JSON.stringify(argMeta.default || []);
                        break;
                    case "dict":
                        input = document.createElement("textarea");
                        input.rows = 3;
                        input.placeholder = JSON.stringify(argMeta.default || {});
                        break;
                    default:
                        input = document.createElement("input");
                        input.type = "text";
                        input.value = argMeta.default || "";
                }

                input.name = "args[" + argName + "]";

                // Handle choices (drop-down)
                if (argMeta.choices) {
                    const select = document.createElement("select");
                    select.name = "args[" + argName + "]";
                    argMeta.choices.forEach(choice => {
                        const opt = document.createElement("option");
                        opt.value = choice;
                        opt.text = choice;
                        if (choice === argMeta.default) opt.selected = true;
                        select.appendChild(opt);
                    });
                    input = select;
                }

                const div = document.createElement("div");
                div.appendChild(label);
                div.appendChild(input);
                argsDiv.appendChild(div);
            }
             // show example if available
          if (cmdInfo.example) {
            exampleDiv.innerHTML =
              `<h4>Example Question:</h4><pre>${cmdInfo.example}</pre>`;
             }
    else     {
            exampleDiv.innerHTML =
              `<h4>Example Question:</h4><pre>Not available</pre>`;
             }

} // end function

        function updateCommands() {
            const category = document.getElementById("selectcategory").value;
            const commandSelect = document.getElementById("selectcommand");

            // Clear existing options
            commandSelect.innerHTML = "";

            // Add default "random" option
            const optRandom = document.createElement("option");
            optRandom.value = "random";
            optRandom.text = "Random Question";
            commandSelect.appendChild(optRandom);

            // Get commands for the chosen category
            let cmds = [];
            if (category === "random") {
                // merge all commands from all categories
                for (const c in categoryCommands) {
                    cmds = cmds.concat(categoryCommands[c]);
                }
            } else {
                cmds = categoryCommands[category] || [];
            }

            // Add options
            cmds.forEach(cmd => {
                const opt = document.createElement("option");
                opt.value = cmd.name;
                opt.text = cmd.short;
                commandSelect.appendChild(opt);
            });
        }

        // Initialize on load
        window.onload = function() {
            updateCommands();
            document.getElementById("selectcommand").addEventListener("change", updateArgsForm);
        };


function resetForm() {
    // reset selects
    document.getElementById("selectcategory").value = "random";
    document.getElementById("selectformat").value = "html";
    document.getElementById("selectquiz").value = "random";
    document.getElementById("random").checked = false;

    // re-update commands dropdown + args
    updateCommands();
    document.getElementById("selectcommand").value = "random";
    updateArgsForm();

    // clear result div
    document.getElementById("resultDiv").innerHTML =
        '<pre id="resultPre">Result will appear here...</pre>';
}

    </script>
</head>
<body>
    <h2>Select Command to generate a Quiz</h2>
<!--    <form method="post" action="/submit">-->
    <div style="display:flex; gap:20px;">
  <!-- Left: form -->
  <div style="flex:1;">


    <form id="quizForm">
                <div>
        <select id="selectcategory" name="category" onchange="updateCommands()">
            <option value="random" selected> Random Category</option>
            {% for cat_key, cat_value in categories_dict.items() %}
                <option value="{{cat_key}}">{{cat_value.short}}</option>
            {% endfor %}
        </select>
<div class="hint">Choose a category to filter commands.</div>
        </div>
        <div>
  <label for="selectcommand">Command</label>
        <select id="selectcommand" name="command">
            <option value="random" selected>Random Question</option>
            <!-- will be updated dynamically -->
        </select>
  <div id="commandHint" class="hint"></div>
        </div>
        <select id="selectformat" name="outformat">
            <option value="html"selected>HTML</option>
            <option value="tex">Tex</option>
        </select>
        <select id="selectquiz" name="quiz_id">
            <option value="random"selected>Random</option>
            {% for  qi in quiz_id_list %}
            <option value="{{qi}}"selected>{{qi}}</option>
            {% endfor %}
            <!-- will be updated dynamically -->
        </select>
 <div id="argsForm"></div>
        <input name="random" id="random" type="checkbox"/> random data for question.<br/>
        <button type="submit">Submit</button>
        <button type="button" onclick="resetForm()">Reset</button>
    </form>

  </div>

  <!-- Right: preview panel -->
  <div style="flex:1; border:1px solid #ccc; padding:10px;">
    <h3>Preview</h3>
      <div id="exampleDiv" style="margin-top:15px; padding:10px; border:1px dashed #aaa;">
  Select a command to see an example question here.
</div>

    <div id="previewPanel">Select options to preview question...</div>
  </div>
</div>

    {% if debug %}
    <h1> commands json </h1>
    <pre>{{ commands_dict_json }};</pre>
    {%endif%}

    <div id="spinner" style="display:none; text-align:center; margin-top:10px;">
  <div class="loader"></div>
  <p>Generating quiz...</p>
</div>
<div id="resultDiv" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px;">
    <pre id="resultPre">Result will appear here...</pre>
</div>
</body>
    <script>
        //(update preview live)
function updatePreview() {
  const command = document.getElementById("selectcommand").value;
  const args = {};
  document.querySelectorAll("#argsForm input, #argsForm select, #argsForm textarea").forEach(el => {
    if (!el.name) return;
    let key = el.name.replace(/^args\[|\]$/g, "");
    args[key] = el.type === "checkbox" ? el.checked : el.value;
  });

  // simple preview text
  let html = `<p><b>Command:</b> ${command}</p>`;
  html += `<pre>${JSON.stringify(args, null, 2)}</pre>`;

  document.getElementById("previewPanel").innerHTML = html;
}

// hook into form changes
document.addEventListener("input", updatePreview);
document.addEventListener("change", updatePreview);

                // display a hint fro current command
document.getElementById("selectcommand").addEventListener("change", function() {
  const value = this.value;
  document.getElementById("commandHint").textContent = commandsInfo[value].long || value;
});
        /* submit function */
        document.addEventListener("DOMContentLoaded", function () {
        const form= document.getElementById("quizForm").addEventListener("submit", async function (e) {
      e.preventDefault(); // prevent normal form submission

    // show spinner, clear result
        document.getElementById("spinner").style.display = "block";
        document.getElementById("resultDiv").innerHTML =
          '<pre id="resultPre">Generating...</pre>';

      const category = document.getElementById("selectcategory").value;
      const command = document.getElementById("selectcommand").value;
      const outformat = document.getElementById("selectformat").value;
      const quizid = document.getElementById("selectquiz").value;
      const select_random_values = document.getElementById("random").checked;


      // Collect args from the dynamically generated argsForm
        const args = {[command]:{}};
        const inputs = document.querySelectorAll("#argsForm input, #argsForm select, #argsForm textarea");
        inputs.forEach(el => {
          if (!el.name || !el.name.startsWith("args[")) return;
            // clean key
            let key = el.name;
            key = key.slice(5, -1); // strip args[...] wrapper
            let value = ""
          if (el.type === "checkbox") {
             value = el.checked;
          } else if (el.type === "radio") {
            if (el.checked)
               value= el.value;
          } else {
            value = el.value;
          }
            args[command][key] = value;
        });
      const payload = {
        category: category,
        command: command,
        select_random_values:select_random_values,
        outformat:outformat,
        quizid:quizid,
        args: args
  };
//            console.log("payload", payload);



    try {
      const response = await fetch("/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });


        const result = await response.text();
        document.getElementById("resultDiv").innerHTML = result;
        console.log("Server response:", result);
        }
                catch (err) {
      document.getElementById("resultDiv").innerHTML =
        `<pre>Error: ${err.message}</pre>`;
    } finally {
      // hide spinner
      document.getElementById("spinner").style.display = "none";
    }
//const result = await response.json();
//console.log("Server response:", result);
//      // (optional) display the result in the page
//
//      alert(JSON.stringify(result, null, 2));
    });
    });
    </script>
</html>

