{# =========================================================
   Shared Macro: Conversion Table
   Arguments:
     input_bits : list of input bits (string list)
     output_bits: list of output bits (string list)
     steps      : list of step strings
     mode       : "bin2gray" or "gray2bin"
   ========================================================= #}
{% macro conversion_table(input_bits, output_bits, steps, mode="bin2gray") %}
\begin{center}
\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|c|*{{ input_bits|length }}{c|}}
  \hline
  {% if mode == "bin2gray" %}
    Binary &
  {% else %}
    Gray &
  {% endif %}
  {% for b in input_bits %}
    {{ b }} {% if not loop.last %}&{% endif %}
  {% endfor %} \\
  \hline

  Arrows &
  {% for i in range(input_bits|length) %}
    {% if i == 0 %}
      \textcolor{blue}{$\downarrow$} &
    {% else %}
      {% if mode == "bin2gray" %}
        \textcolor{red}{$\searrow \oplus \downarrow$} {% if not loop.last %}&{% endif %}
      {% else %}
        \textcolor{blue}{$\nearrow \oplus \downarrow$} {% if not loop.last %}&{% endif %}
      {% endif %}
    {% endif %}
  {% endfor %} \\
  \hline

  {% if mode == "bin2gray" %}
    Gray &
  {% else %}
    Binary &
  {% endif %}
  {% for o in output_bits %}
    \textbf{ {{ o }} } {% if not loop.last %}&{% endif %}
  {% endfor %} \\
  \hline

  Steps &
  {% for step in steps %}
    {\scriptsize {{ step|replace("⊕","$\oplus$") }} } {% if not loop.last %}&{% endif %}
  {% endfor %} \\
  \hline
\end{tabular}
\end{center}
{% endmacro %}

% =========================================================
% Macro: illustrate bit change from x to x+1 sequence
% =========================================================
{% macro illustrate_bit_change(x, x_next) %}
\subsection*{Binary Increment Illustration}

$x$: {{ x|join }} $\;\to\;$ $x+1$: {{ x_next|join }}

\begin{tabular}{|c|*{{ x|length }}{c|}}
\hline
Position & {% for i in range(x|length) %} {{ i }} {% if not loop.last %}&{% endif %} {% endfor %} \\
\hline
$x$ & {% for bit in x %} {{ bit }} {% if not loop.last %}&{% endif %} {% endfor %} \\
\hline
$x+1$ & {% for i in range(x|length) %}
  {% if x[i] != x_next[i] %}
    \cellcolor{yellow}\textbf{ {{ x_next[i] }} }
  {% else %}
    {{ x_next[i] }}
  {% endif %}
  {% if not loop.last %}&{% endif %}
{% endfor %} \\
\hline
\end{tabular}

\emph{Highlighted cell(s) = changed bit(s)}
{% endmacro %}

% =========================================================
% Macro: illustrate gray sequence
% =========================================================

{% macro illustrate_gray_sequence(gray_codes, x_name="x") %}
\subsection*{Gray Code Sequence (Bit Changes)}

\begin{tabular}{|c|*{{ gray_codes[0]|length }}{c|}}
\hline
Step & {% for b in range(gray_codes[0]|length) %} Bit {{ loop.index0 }} {% if not loop.last %}&{% endif %} {% endfor %} \\
\hline
{% for i in range(gray_codes|length) %}
{{ x_name }} + {{ i }} &
{% for j in range(gray_codes[i]|length) %}
  {% if i > 0 and gray_codes[i][j] != gray_codes[i-1][j] %}
    \cellcolor{yellow}\textbf{ {{ gray_codes[i][j] }} }
  {% else %}
    {{ gray_codes[i][j] }}
  {% endif %}
  {% if not loop.last %}&{% endif %}
{% endfor %} \\
\hline
{% endfor %}
\end{tabular}

\emph{Highlighted cell shows the bit that flipped compared to the previous Gray code.}
{% endmacro %}


% =========================================================
% Main Template: Binary <-> Gray Exercises (LaTeX)
% =========================================================
{% if RENDER_MODE == "question" %}

\section*{Exercise}

\textbf{Convert the following number from Binary to Gray:}\\
حوّل من الثنائي إلى ترميز غراي

\[
  {{ number_bin|join }}
\]

\bigskip

\textbf{Convert the following number from Gray to Binary:}\\
حوّل من ترميز غراي إلى الثنائي

\[
  {{ number_gray|join }}
\]

{% elif RENDER_MODE == "answer" %}

\section*{Solutions}

\subsection*{Binary $\to$ Gray Conversion}


{{conversion_table(number_bin, number_gray, steps_bin2gray, mode="bin2gray")}}
\bigskip

\subsection*{Gray $\to$ Binary Conversion}

 {{conversion_table(number_gray, number_bin, steps_gray2bin, mode="gray2bin")}}

\bigskip

\subsection*{Illustration of Bit Change (Next Gray Code)}
{{ illustrate_bit_change(gray_sequence[0], gray_sequence[1]) }}

\bigskip

\subsection*{Gray Code Sequence}
{{ illustrate_gray_sequence(gray_sequence, "x") }}

{% endif %}
