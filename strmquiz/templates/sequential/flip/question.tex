{# -----------------------
 define a basic flip
-------------------#}
{%macro define_basic_flip(type="D", id="DMod", output_var="Q")%}
{% if type.lower() == "d" %}
    \tikzset{flipflop {{id}}/.style={flipflop, dot on notQ,
        flipflop def={t1=D, t6=${{output_var}}$,t4={\ctikztextnot{${{output_var}}$}},
           c3=1},
    },
    }
{%elif type.lower() == "jk"%}
\tikzset{flipflop {{id}}/.style={flipflop,  dot on notQ,
            flipflop def={t1=J, t3=K,t6=${{output_var}}$, t4={\ctikztextnot{${{output_var}}$}},
               c2=1},
        },
}
{%elif type.lower() == "rs"%}
\tikzset{flipflop {{id}}/.style={flipflop,  dot on notQ,
                    flipflop def={t1=R,t3=S,t6=${{output_var}}$, t4={\ctikztextnot{${{output_var}}$}},
                       n4=1, c2=0},
                },
}
{%endif%}
{%endmacro%}


{# -----------------------
 draw a link between two flips
-------------------#}
{%macro link(name_source, name_target, type_target="D", method="direct")%}
{% if type_target.lower() == "d" %}
    {% if method.lower() == "direct" %}
       \draw ({{name_source}}.pin 6) -- ({{name_target}}.pin 1);
    {% elif method.lower() == "inverse" %}
       \draw ({{name_source}}.pin 4) -- ({{name_target}}.pin 1);
    {% elif method.lower() == "clock" %}
       \draw ({{name_source}}.pin 6) -- ({{name_target}}.pin 3);
    {% elif method.lower() == "inverse_clock" %}
       \draw ({{name_source}}.pin 4) -- ({{name_target}}.pin 3);
    {% endif%}
{%elif type_target.lower() in ("rs", "jk") %}
    {% if method.lower() == "direct" %}
       \draw ({{name_source}}.pin 4) -- ({{name_target}}.pin 3);
       \draw ({{name_source}}.pin 6) -- ({{name_target}}.pin 1);
    {% elif method.lower() == "inverse" %}
       \draw ({{name_source}}.pin 4) -- ({{name_target}}.pin 1);
       \draw ({{name_source}}.pin 6) -- ({{name_target}}.pin 3);
    {% elif method.lower() == "clock" %}
       \draw ({{name_source}}.pin 6) -- ({{name_target}}.pin 2);
    {% elif method.lower() == "inverse_clock" %}
       \draw ({{name_source}}.pin 4) -- ({{name_target}}.pin 2);
    {% endif%}

{%endif%}
{%endmacro%}
{%macro truth_table(type="D",edge="rising", customized=False, custom_vars =["X","Y"], custom_values=["1","Q","X","Q'"])%}
\textbf{ Truth table of {{type}} flipflop }\\
{% set edge_symbol = '\\frontmontant' if edge == "rising" else '\\frontmontant' %}
{% if type.lower() in ("custom","customized") %}
\begin{tabular}{|c|c|c||c|}
  \hline Ck & {{custom_vars[0]}} & {{custom_vars[1]}} &  $Q_t$ \\
  \hline 0 & X & X & $Q_{t-1}$ \\
  \hline {{edge_symbol}}&0 & 0 & ${{custom_values[0]}}$ \\
  \hline {{edge_symbol}}& 0 & 1 & ${{custom_values[1]}}$\\
  \hline  {{edge_symbol}}&1 & 0 & ${{custom_values[2]}}$ \\
  \hline  {{edge_symbol}}& 1 & 1 & ${{custom_values[3]}}$\\
  \hline
  \end{tabular}
{% elif type.lower() == "d" %}
  \begin{tabular}{|c|c|c|}
   \hline Ck & D & $Q_t$\\
   \hline 0/1 & X & $Q_{t-1}$\\
   \hline {{edge_symbol}}&  0 & 0\\
   \hline {{edge_symbol}}&   1 & 1\\
   \hline
    \end{tabular}
{% elif type.lower() == "dlatch" %}
 \begin{tabular}{|c|c|c|}
  \hline V & D & $Q_t$\\
  \hline 0 & X & $Q_{t-1}$\\
  \hline 1 &0 & 0\\
  \hline 1 & 1 & 1\\
  \hline
   \end{tabular}
{% elif type.lower() == "jk" %}
\begin{tabular}{|c|c|c||c|l|}
  \hline Ck & J & K &  $Q_t$ &\\
  \hline 0 & X & X & $Q_{t-1}$ &\\
  \hline {{edge_symbol}}&0 & 0 & $Q_{t-1}$ &\\
  \hline {{edge_symbol}}& 0 & 1 & 0&\\
  \hline  {{edge_symbol}}&1 & 0 & 1 &\\
  \hline  {{edge_symbol}}& 1 & 1 & $\overline{Q_{t-1}}$ & \textcolor{red}{Toggle}\\
  \hline
  \end{tabular}
{% elif type.lower() == "jkasyn" %}
\begin{tabular}{|l|c|c|c|c|c||c|l|}
  \hline
  Mode & Pr & Cl & Ck & J & K & Q+ & Remark \hfill\aRL{ملاحظة} \\
  \hline
  Asynchronous & 0 & 0 & X & X & X & X & Forbidden\hfill\aRL{ممنوع} \\
  \aRL{نمط غير متزامن} & 0 & 1 & X & X & X & 1 & Set to 1 \hfill\aRL{توحيد} \\
  & 1 & 0 & X & X & X & 0 & Set to 0 \hfill\aRL{تصفير} \\
  \hline
  \hline
  Synchronous & 1 &1 & 0/1 & X & X & Q & Memory State \hfill\aRL{ذاكرة} \\
  \aRL{نمط متزامن} & 1 &1 & {{edge_symbol}}&  0 & 0 & Q & Memory State \hfill\aRL{ذاكرة} \\
  & 1 &1 & {{edge_symbol}}&  0 & 1 & 0 & Set to 0 \hfill \aRL{تصفير} \\
  & 1 &1 & {{edge_symbol}}&  1 & 0 & 1 & Set to 1\hfill \aRL{توحيد} \\
  & 1 &1 & {{edge_symbol}}&  1 & 1 & $\overline{Q}$ & Toggle \hfill\aRL{قلب} \\
  \hline
  \end{tabular}
{% elif type.lower() == "rs" %}
\begin{tabular}{|c|c||c|l|}
	\hline R & S & $Q_t$ &\\
	\hline 0 & 0 & $Q_{t}$ &Memory State \aRL{ذاكرة}\\
	\hline 0 & 1 & 1 &Set to 1 \aRL{توحيد}\\
	\hline 1 & 0 & 0 & Reset to 0 \aRL{تصفير}\\
	\hline 1 & 1 & X &  {\color{red}Forbidden \aRL{ممنوعة}}\\
	\hline
 \end{tabular}
{% elif type.lower() == "rst" %}
 \begin{tabular}{|c|c|c||c|c|l|}
  \hline Ck & R & S &  $Q_t$ & $\overline{Q_t}$&\\
  \hline 0 & X & X & $Q_{t-1}$ & $\overline{Q_{t-1}}$&\\
  \hline {{edge_symbol}}&0 & 0 & $Q_{t-1}$ & $\overline{Q_{t-1}}$&\\
  \hline {{edge_symbol}}& 0 & 1 & 1 & 0&\\
  \hline  {{edge_symbol}}&1 & 0 & 0 & 1&\\
  \hline  {{edge_symbol}}& 1 & 1 & X & X & {\color{red}Forbidden}\\
  \hline
  \end{tabular}
{% else%}
    \textbf{No Table to display, please check the flip type "{{type}}", use customized type if needed }
{% endif%}
{%endmacro%}
{# -----------------------
 Draw a basic flip by id and x, y pos
-------------------#}

{%macro place_flip(id="DMod", name="", xpos=0, ypos=0)%}
\node[flipflop {{id}}] ({{name}}) at ({{xpos}},{{ypos}}) {};
{%endmacro%}
{# -----------------------
 Draw a clock
-------------------#}
{%macro draw_clock(name="Ck", label="Ck", xpos=0.4, ypos=-1)%}
\draw ({{xpos}},{{ypos}}) node[circle, fill, inner sep=1pt] {};
\draw ({{xpos}},{{ypos}}) node[left] ({{name}})  {${{label}}$};
{%endmacro%}

{# -----------------------
 link  a clock
-------------------#}
{%macro link_clock(name_clock="Ck", name_target="D", type_target="d")%}

{% if type_target.lower() == "d" %}
       \draw ({{name_clock}}) -| ({{name_target}}.pin 3);
{%elif type_target.lower() in ("rs", "jk") %}
       \draw ({{name_clock}}) -| ({{name_target}}.pin 2);
{%endif%}
{%endmacro%}


{# -----------------------
 draw a resiter generic
-------------------#}
{%macro _draw_register_generic(flips_list= ["D","JK","RS"], outputs=["Q0","Q1", "Q2"],size=3)%}

{% if size != flips_list|length or size != outputs|length %}
 Warning: check parameters, The size '{{size}}' is different from flips list length '{{flips_list|length}}' or
 '{{outputs|length}}'
{%else%}
    {# draw a clock #}
    {{draw_clock(name="Ck", label="Ck", xpos=0, ypos=0)}}
    {# draw a modules #}
    {% set ns = namespace(name="", id="", xpos=0, prev_name="", prev_type="", type="") %}
    {% set ypos = 2 %}
    {% for i in range(size) %}
        {% set ns.xpos = 2+3*i %}
        {% set ns.name = "flip"+(i|string) %}
        {% set ns.type = flips_list[i].upper() %}
        {% set ns.id = flips_list[i].upper()+"Mod" %}
        {{place_flip(id=ns.id, name=ns.name, xpos=ns.xpos, ypos=ypos)}}

        {# link current with clock #}
        {{link_clock (name_clock="Ck", name_target=ns.name, type_target=ns.type)}}

        {# link previous with current #}
        {% if ns.prev_name %}
            {{link(name_source=ns.prev_name, name_target=ns.name, type_target=ns.type, method="direct")}}
        {% endif %}
        {% set ns.prev_name = ns.name %}
        {% set ns.prev_type = ns.type %}
    {%endfor%}

{%endif%}
{%endmacro%}


{# -----------------------
 draw a resiter one type flip
-------------------#}
{%macro draw_register(flip="D", register_type="",size=3)%}
{% set flips_list = [flip]*size %}
{% set ns = namespace(outputs = []) %}
{% for i in range(size) %}
    {% set _ = ns.outputs.append("Q" ~ i|string) %}
{% endfor %}
{{ _draw_register_generic(flips_list= flips_list, outputs=ns.outputs,size=size)}}

{%endmacro%}



{# -----------------------
 draw a generic counter
-------------------#}
{%macro _draw_counter_generic(flips_list= ["D","JK","RS"], outputs=["Q0","Q1", "Q2"],size=3, counter_type="up")%}

{% if size != flips_list|length or size != outputs|length %}
 Warning: check parameters, The size '{{size}}' is different from flips list length '{{flips_list|length}}' or
 '{{outputs|length}}'
{%else%}
    {# draw a clock #}
    {{draw_clock(name="Ck", label="Ck", xpos=0, ypos=0)}}
    {# draw a modules #}
    {% set ns = namespace(name="", id="", xpos=0, prev_name="", prev_type="", type="") %}
    {% set ypos = 2 %}
    {% for i in range(size) %}
        {% set ns.xpos = 2+3*i %}
        {% set ns.name = "flip"+(i|string) %}
        {% set ns.type = flips_list[i].upper() %}
        {% set ns.id = flips_list[i].upper()+"Mod" %}
        {{place_flip(id=ns.id, name=ns.name, xpos=ns.xpos, ypos=ypos)}}

        {# link previous with current #}
        {% if ns.prev_name %}
            {{link(name_source=ns.prev_name, name_target=ns.name, type_target=ns.type, method="clock")}}
        {% endif %}
        {% set ns.prev_name = ns.name %}
        {% set ns.prev_type = ns.type %}
    {%endfor%}

{%endif%}
{%endmacro%}

{# -----------------------
 draw a counter one type flip
-------------------#}
{%macro draw_counter(flip="JK", counter_type="",size=3)%}
{% set flips_list = [flip]*size %}
{% set ns = namespace(outputs = []) %}
{% for i in range(size) %}
    {% set _ = ns.outputs.append("Q" ~ i|string) %}
{% endfor %}
{{ _draw_counter_generic(flips_list= flips_list, outputs=ns.outputs,size=size, counter_type=counter_type)}}

{%endmacro%}

{#----------------------------------------------------------
 Main_call
----------------------------------------------------------#}
{#  --------------- Define basic flips -------#}
{{ define_basic_flip(type="D", id="DMod", output_var="Q2")}}
{{ define_basic_flip(type="JK", id="JKMod", output_var="Q0")}}
{{ define_basic_flip(type="RS", id="RSMod", output_var="Q1")}}


\section{Flip}
{{ truth_table("D")}}

{{ truth_table("JK")}}

{{ truth_table("JK", edge="falling")}}

{{ truth_table("RS")}}

{{ truth_table("Dlatch")}}

{{ truth_table("jkasyn")}}

{{ truth_table("custom")}}
{{ truth_table("customX")}}

%---------------------------------------------------

\begin{circuitikz}
{{place_flip(id="JKMod", name="JK0", xpos=2, ypos=4)}}
{{place_flip(id="DMod", name="D0", xpos=2, ypos=0)}}
{{place_flip(id="RSMod", name="RS0", xpos=5, ypos=4)}}

{{place_flip(id="DMod", name="D1", xpos=2, ypos=8)}}
{{place_flip(id="RSMod", name="RS1", xpos=5, ypos=8)}}
{{place_flip(id="JKMod", name="JK1", xpos=8, ypos=8)}}
{{place_flip(id="JKMod", name="JK2", xpos=11, ypos=8)}}
{{place_flip(id="DMod", name="D2", xpos=14, ypos=8)}}

{{draw_clock(name="Ck", label="H", xpos=0, ypos=6)}}

{{link_clock (name_clock="Ck", name_target="D1", type_target="d")}}
{{link_clock (name_clock="Ck", name_target="JK1", type_target="jk")}}

{{link(name_source="D1", name_target="RS1", type_target="rs", method="direct")}}
{{link(name_source="RS1", name_target="JK1", type_target="jk", method="inverse")}}
{{link(name_source="JK1", name_target="JK2", type_target="rs", method="clock")}}
{{link(name_source="JK1", name_target="JK2", type_target="jk", method="clock")}}
{{link(name_source="JK2", name_target="D2", type_target="d", method="inverse_clock")}}
{{link(name_source="JK2", name_target="D2", type_target="d", method="clock")}}
%\node[flipflop JKMod] (JK0) at (2,4) {};
%\node[flipflop DMod] (D0) at (2,0) {};

%\node[flipflop RSMod] (RS0) at (5,4) {};
\node[nor port, scale=0.5] (mynor) at (8,3) {};


\draw (JK0.pin 4) -- (RS0.pin 3);
\draw (JK0.pin 6) -- (RS0.pin 1);

\draw (D0.pin 4) -| ++(0.3,-1) node{} -| (D0.pin 1);

\draw (1.05,-0.83) circle [radius=0.1];
\fill [white] (1.05,-0.83) circle [radius=0.09];

\node[above] (A0) at (-1.2,4.6) {$A$};
\node[above] (B0) at (-1.2,2.9) {$B$};
\node[above] (Q3) at (8.2, 3) {$Q_3$};

\draw (JK0.pin 1) -- (A0);
\draw (JK0.pin 3) -- (B0);



\draw (mynor.in 1) -- (RS0.pin 4);
\draw (mynor.in 2) |- (D0.pin 4);


\draw (0.4,-1) node[left] (clk1)  {$clock$};
\draw (clk1) |- (JK0.pin 2);
\draw (clk1) |- (D0.pin 3);



\end{circuitikz}

 \textbf{Register}

\begin{circuitikz}
{{_draw_register_generic(flips_list= ["D","JK","RS"], outputs=["Q0","Q1", "Q2"],size=3)}}

\end{circuitikz}

 \textbf{Register  n bits}

\begin{circuitikz}
{{draw_register(flip="D", register_type="",size=6)}}

\end{circuitikz}

 \textbf{Register  n bits Jk}

\begin{circuitikz}
{{draw_register(flip="JK", register_type="",size=6)}}

\end{circuitikz}

 \textbf{Counter  n bits Jk}

\begin{circuitikz}
{{draw_counter(flip="JK", counter_type="",size=6)}}

\end{circuitikz}