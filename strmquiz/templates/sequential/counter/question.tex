{% set debug = False %}
{% import "sequential/macros/flipmacros.tex" as flpmacro%}
{% import "sequential/macros/timingmacros.tex" as tmmacro%}
{# -----------------------
 draw a generic counter
-------------------#}
{%macro _draw_counter_generic(flips_list= ["D","JK","RS"], outputs=["Q0","Q1", "Q2"],size=3, counter_type="up")%}

{% if size != flips_list|length or size != outputs|length %}
 Warning: check parameters, The size '{{size}}' is different from flips list length '{{flips_list|length}}' or
 '{{outputs|length}}'
{%else%}
    {# draw a clock #}
    {{ flpmacro.draw_clock(name="Ck", label="Ck", xpos=0, ypos=2)}}
    {# draw a modules #}
    {% set ns = namespace(name="", id="", xpos=0, prev_name="", prev_type="", type="") %}
    {% set ypos = 2 %}
    {% for i in range(size) %}
        {% set ns.xpos = 2+3*i %}
        {% set ns.name = "flipc"+(i|string) %}
        {% set ns.type = flips_list[i].upper() %}
        {% set ns.id = "JKA" if flips_list[i].upper() =="JK" else flips_list[i].upper()   %}
        {{ flpmacro.place_flip(id=ns.id, name=ns.name, xpos=ns.xpos, ypos=ypos)}}

        {# link current with clock #}
        {% if loop.first %}
        {{ flpmacro.link_clock (name_clock="Ck", name_target=ns.name, type_target=ns.type)}}
        {% endif%}

        {# draw a Vcc var #}
        {{ flpmacro.draw_input_var(name="Vcc"~(i|string), label="Vcc", xpos=ns.xpos-1.5, ypos=ypos+2)}}
        {{ flpmacro.link_var(name_var="Vcc"~(i|string), name_target=ns.name, type_target=ns.type, target_pins=["up","down","pin 1", "pin 3"])}}
        {# link previous with current #}
        {% if ns.prev_name %}
            {{ flpmacro.link(name_source=ns.prev_name, name_target=ns.name, type_target=ns.type, method="clock")}}
        {% endif %}
        {% set ns.prev_name = ns.name %}
        {% set ns.prev_type = ns.type %}
    {%endfor%}

{%endif%}
{%endmacro%}

{# -----------------------
 draw a counter one type flip
-------------------#}
{%macro draw_counter(flip="JKA", counter_type="",size=3)%}
{% set flips_list = [flip]*size %}
{% set ns = namespace(outputs = []) %}
{% for i in range(size) %}
    {% set _ = ns.outputs.append("Q" ~ i|string) %}
{% endfor %}
{{ _draw_counter_generic(flips_list= flips_list, outputs=ns.outputs,size=size, counter_type=counter_type)}}
{%endmacro%}
{#----------------------------------------------------------
 Main_call
----------------------------------------------------------#}
\section{Counter}

{{flpmacro.define_standard_flips()}}

{% if RENDER_MODE == "question" %}

    Let have the following setup
    \begin{arab}[utf]
إليك هذا التركيب
    \end{arab}

   \begin{circuitikz}
    {{draw_counter(flip="JKA", counter_type="",size=4)}}
    \end{circuitikz}

    \begin{circuitikz}
    {{_draw_counter_generic(flips_list= counter_data.flip_type_list, outputs=counter_data.outputs,
                            size=counter_data.nbits,
                            )}}

    \end{circuitikz}

    Cite the truth table of flipflop {{counter_data.flip_type_list[0]}}.

    \begin{arab}[utf]
    اذكر جدول الحقيقة للقلاب \LR{ {{counter_data.flip_type_list[0]}}}.
    \end{arab}

   Complete the following timing diaragm, according to given flipflop.

       \begin{arab}[utf]
أكمل المخطط المنطقي الآتي، حسب القلاب المعطى.
    \end{arab}

  {{tmmacro.draw_timing_diagram(data, mode="question")}}

{%endif%} % end quesion
{#----------------------------------------------------------
  Answer
----------------------------------------------------------#}
{% if RENDER_MODE == "answer" %}

        Cite the truth table of flipflop {{counter_data.flip_type_list[0]}}.

        \begin{arab}[utf]
        اذكر جدول الحقيقة للقلاب \LR{ {{counter_data.flip_type_list[0]}}}.
        \end{arab}

        {{flpmacro.truth_table(type=counter_data.flip_type_list[0],
                    edge="rising")}}

   {{tmmacro.draw_timing_diagram(data, mode="answer")}}

{%endif%}
{#----------------------------------------------------------
 Main_call
----------------------------------------------------------#}
{%if debug and RENDER_MODE == "answer"  %}
 \textbf{Counter  n bits Jk}
\begin{circuitikz}

{{draw_counter(flip="JKA", counter_type="",size=4)}}

\end{circuitikz}

 \textbf{flipfop syn/asyn Jk}

\begin{circuitikz}
{{ flpmacro.place_flip(id="JKA", name="jk4", xpos=5, ypos=4)}}
\end{circuitikz}
{%endif%} % end debug
